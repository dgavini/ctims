FROM node:16.14-slim

#RUN apk add --update python3 make g++ && rm -rf /var/cache/apk/*
RUN apt-get update && \
    apt-get install -y \
    python3 \
    make \
    g++ && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /usr/src
RUN mkdir -p /usr/src/app
COPY package.json /usr/src/
COPY yarn.lock /usr/src/

COPY ./ /usr/src/app/
RUN mkdir -p /usr/src/app/dist
WORKDIR /usr/src/app
RUN yarn install --loglevel=error

#CMD ["yarn", "schema:generate-client"]
#RUN npx nx build api
#ARG RESTSERVER_PORT=3000
#ENV RESTSERVER_PORT=$RESTSERVER_PORT
#EXPOSE ${RESTSERVER_PORT}

ARG KEYCLOAK_REALM
ARG KEYCLOAK_URL
ARG KEYCLOAK_CLIENT_ID
ARG KEYCLOAK_CLIENT_SECRET
ARG KEYCLOAK_ADMIN_CLIENT_ID
ARG KEYCLOAK_ADMIN_CLIENT_SECRET
ARG KEYCLOAK_TOKEN_ENDPOINT
ARG KEYCLOAK_CLIENT_UUID
ARG PRISMA_FIELD_ENCRYPTION_KEY
ARG MM_API_URL
ARG CTIMS_ENV
ARG MM_API_TOKEN
ARG CTIMS_API_VERSION

ENV KEYCLOAK_REALM=$KEYCLOAK_REALM
ENV KEYCLOAK_URL=$KEYCLOAK_URL
ENV KEYCLOAK_CLIENT_ID=$KEYCLOAK_CLIENT_ID
ENV KEYCLOAK_CLIENT_SECRET=$KEYCLOAK_CLIENT_SECRET
ENV KEYCLOAK_ADMIN_CLIENT_ID=$KEYCLOAK_ADMIN_CLIENT_ID
ENV KEYCLOAK_ADMIN_CLIENT_SECRET=$KEYCLOAK_ADMIN_CLIENT_SECRET
ENV KEYCLOAK_TOKEN_ENDPOINT=$KEYCLOAK_TOKEN_ENDPOINT
ENV KEYCLOAK_CLIENT_UUID=$KEYCLOAK_CLIENT_UUID
ENV PRISMA_FIELD_ENCRYPTION_KEY=$PRISMA_FIELD_ENCRYPTION_KEY
ENV MM_API_URL=$MM_API_URL
ENV CTIMS_ENV=$CTIMS_ENV
ENV MM_API_TOKEN=$MM_API_TOKEN
ENV CTIMS_API_VERSION=$CTIMS_API_VERSION

RUN yarn generate:build
#RUN yarn start:prod
CMD ["yarn", "start:prod"]
#CMD ["tail", "-f", "/dev/null"]

